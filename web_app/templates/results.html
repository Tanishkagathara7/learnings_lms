{% extends "base.html" %}

{% block title %}Study Plan Results - AI Study Pal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="fas fa-graduation-cap me-2"></i>Your AI-Generated Study Plan
                </h2>
                <p class="text-muted mb-0">
                    Subject: <strong>{{ results.last_subject }}</strong> | 
                    Daily Hours: <strong>{{ results.last_hours }}</strong> | 
                    Scenario: <strong>{{ results.study_plan.scenario.replace('_', ' ').title() }}</strong>
                </p>
                {% if results.selected_topics %}
                <div class="mt-2">
                    <small class="text-muted">Selected Topics: </small>
                    {% for topic in results.selected_topics %}
                        <span class="badge bg-info me-1">{{ topic }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div>
                <a href="{{ url_for('download_plan') }}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Download CSV
                </a>
                <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-2"></i>New Plan
                </a>
            </div>
        </div>

        <!-- Study Plan Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4>{{ results.study_plan.summary.total_study_hours }}h</h4>
                        <small>Total Weekly Hours</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <i class="fas fa-book fa-2x mb-2"></i>
                        <h4>{{ results.study_plan.summary.reading_hours }}h</h4>
                        <small>Reading Time</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <i class="fas fa-pencil-alt fa-2x mb-2"></i>
                        <h4>{{ results.study_plan.summary.practice_hours }}h</h4>
                        <small>Practice Time</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <i class="fas fa-redo fa-2x mb-2"></i>
                        <h4>{{ results.study_plan.summary.revision_hours }}h</h4>
                        <small>Revision Time</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for different sections -->
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                    <i class="fas fa-calendar-alt me-1"></i>Weekly Schedule
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quiz-tab" data-bs-toggle="tab" data-bs-target="#quiz" type="button">
                    <i class="fas fa-question-circle me-1"></i>Practice Quiz
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                    <i class="fas fa-file-alt me-1"></i>Summary & Tips
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button">
                    <i class="fas fa-lightbulb me-1"></i>Recommendations
                </button>
            </li>
        </ul>

        <div class="tab-content" id="resultTabsContent">
            <!-- Weekly Schedule Tab -->
            <div class="tab-pane fade show active" id="schedule" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>7-Day Study Schedule</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for day, schedule in results.study_plan.daily_schedules.items() %}
                            <div class="col-lg-6 mb-4">
                                <div class="card border-left-primary">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-calendar-day me-2"></i>{{ day }}
                                            <small class="text-muted">({{ schedule.date }})</small>
                                        </h6>
                                        <small class="text-muted">{{ schedule.planned_hours }} hours planned</small>
                                    </div>
                                    <div class="card-body">
                                        {% for activity in schedule.schedule %}
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="activity-icon me-3">
                                                {% if activity.activity == 'Reading' %}
                                                    <i class="fas fa-book text-success"></i>
                                                {% elif activity.activity == 'Practice' %}
                                                    <i class="fas fa-pencil-alt text-info"></i>
                                                {% elif activity.activity == 'Revision' %}
                                                    <i class="fas fa-redo text-warning"></i>
                                                {% else %}
                                                    <i class="fas fa-coffee text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <strong>{{ activity.activity }}</strong>
                                                <span class="badge bg-secondary ms-2">{{ activity.duration }}h</span>
                                                <div class="small text-muted">{{ activity.description }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        
                                        <div class="mt-3">
                                            <strong class="small">Focus Areas:</strong>
                                            <div class="small text-muted">
                                                {% for area in schedule.focus_areas %}
                                                    <span class="badge bg-light text-dark me-1">{{ area }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Tab -->
            <div class="tab-pane fade" id="quiz" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i>AI-Generated Practice Quiz
                            {% if results.quiz %}
                                <span class="badge bg-primary">{{ results.quiz.total_questions }} Questions</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if results.quiz and results.quiz.questions %}
                            <form id="quizForm">
                                {% for question in results.quiz.questions %}
                                {% set question_index = loop.index0 %}
                                <div class="question-block mb-4 p-3 border rounded">
                                    <h6 class="question-title">
                                        Question {{ loop.index }}
                                        {% if question.predicted_difficulty %}
                                            <span class="badge bg-{{ 'success' if question.predicted_difficulty == 'easy' else 'warning' if question.predicted_difficulty == 'medium' else 'danger' }}">
                                                {{ question.predicted_difficulty.title() }}
                                            </span>
                                        {% endif %}
                                    </h6>
                                    <p class="question-text">{{ question.question }}</p>
                                    
                                    {% for option in question.options %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_{{ question_index }}" id="q{{ question_index }}_{{ loop.index0 }}" value="{{ loop.index0 }}">
                                        <label class="form-check-label" for="q{{ question_index }}_{{ loop.index0 }}">
                                            {{ option }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                                
                                <div class="text-center">
                                    <button type="button" class="btn btn-primary" onclick="checkQuizAnswers()">
                                        <i class="fas fa-check me-2"></i>Check Answers
                                    </button>
                                </div>
                            </form>
                            
                            <div id="quizResults" class="mt-4" style="display: none;"></div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No quiz questions available for this subject. Try a different subject or check back later.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Summary & Tips Tab -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>AI-Generated Summary</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ results.summary }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-heart me-2"></i>Motivational Feedback</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-success">
                                    <i class="fas fa-quote-left me-2"></i>{{ results.feedback }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>NLP-Generated Study Tips</h5>
                    </div>
                    <div class="card-body">
                        {% if results.tips and results.tips.study_tips %}
                            <div class="row">
                                <div class="col-md-8">
                                    <ul class="list-group list-group-flush">
                                        {% for tip in results.tips.study_tips %}
                                        <li class="list-group-item border-0 px-0">
                                            <i class="fas fa-check-circle text-success me-2"></i>{{ tip }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Key Topics Identified:</h6>
                                    {% for keyword in results.tips.keywords_extracted[:5] %}
                                        <span class="badge bg-primary me-1 mb-1">{{ keyword }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div class="tab-pane fade" id="recommendations" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-star me-2"></i>Personalized Study Recommendations</h5>
                    </div>
                    <div class="card-body">
                        {% if results.study_plan.recommendations %}
                            <div class="row">
                                {% for recommendation in results.study_plan.recommendations %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-left-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-arrow-right text-success me-3 mt-1"></i>
                                                <p class="mb-0">{{ recommendation }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="alert alert-info mt-4">
                            <h6><i class="fas fa-info-circle me-2"></i>Study Success Tips:</h6>
                            <ul class="mb-0">
                                <li>Stick to your schedule consistently for best results</li>
                                <li>Take regular breaks to maintain focus and avoid burnout</li>
                                <li>Track your progress and adjust the plan as needed</li>
                                <li>Use active learning techniques during practice sessions</li>
                                <li>Review and revise regularly to reinforce learning</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function checkQuizAnswers() {
    const form = document.getElementById('quizForm');
    const formData = new FormData(form);
    const answers = {};
    
    // Collect answers
    for (let [key, value] of formData.entries()) {
        const questionIndex = key.split('_')[1];
        answers[questionIndex] = value;
    }
    
    // Send to server for checking
    fetch('/api/quiz_check', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({answers: answers})
    })
    .then(response => response.json())
    .then(data => {
        displayQuizResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error checking answers. Please try again.');
    });
}

function displayQuizResults(data) {
    const resultsDiv = document.getElementById('quizResults');
    const scorePercentage = Math.round(data.score * 100);
    
    // Generate encouraging message based on performance
    let encouragementMessage = '';
    let alertClass = '';
    let icon = '';
    let celebrationClass = '';
    
    if (scorePercentage >= 90) {
        alertClass = 'success';
        icon = 'fas fa-trophy';
        celebrationClass = 'quiz-celebration celebration-animation';
        encouragementMessage = 'üéâ Outstanding! You\'re a true scholar! Your dedication to learning is truly inspiring. Keep up this excellent work!';
    } else if (scorePercentage >= 80) {
        alertClass = 'success';
        icon = 'fas fa-star';
        celebrationClass = 'bounce-animation';
        encouragementMessage = '‚≠ê Excellent work! You have a strong grasp of the material. You\'re well on your way to mastering this subject!';
    } else if (scorePercentage >= 70) {
        alertClass = 'info';
        icon = 'fas fa-thumbs-up';
        celebrationClass = 'pulse-animation';
        encouragementMessage = 'üëç Great job! You\'re doing well and showing good understanding. A little more practice and you\'ll be an expert!';
    } else if (scorePercentage >= 60) {
        alertClass = 'warning';
        icon = 'fas fa-lightbulb';
        encouragementMessage = 'üí° Good effort! You\'re on the right track. Review the topics you missed and try again - you\'ve got this!';
    } else if (scorePercentage >= 50) {
        alertClass = 'warning';
        icon = 'fas fa-heart';
        encouragementMessage = '‚ù§Ô∏è Don\'t give up! Learning is a journey, and every step counts. Review the material and keep practicing - you\'re improving!';
    } else {
        alertClass = 'info';
        icon = 'fas fa-seedling';
        encouragementMessage = 'üå± Every expert was once a beginner! This is just the start of your learning journey. Review the concepts and try again - you\'ll be amazed at your progress!';
    }
    
    let html = `
        <div class="quiz-results-container">
            <div class="alert alert-${alertClass} text-center mb-4 ${celebrationClass}">
                <i class="${icon} fa-3x mb-3"></i>
                <h4>Quiz Complete!</h4>
                <div class="row justify-content-center mb-3">
                    <div class="col-auto">
                        <div class="display-4 fw-bold">${scorePercentage}%</div>
                        <div class="text-muted">Your Score</div>
                    </div>
                </div>
                <p class="mb-0 encouragement-message">${encouragementMessage}</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center bg-success text-white quiz-score-card">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h3>${data.correct_count}</h3>
                            <small>Correct Answers</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center bg-danger text-white quiz-score-card">
                        <div class="card-body">
                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                            <h3>${data.total_questions - data.correct_count}</h3>
                            <small>Incorrect Answers</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center bg-primary text-white quiz-score-card">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <h3>${data.total_questions}</h3>
                            <small>Total Questions</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list-check me-2"></i>Detailed Answer Review</h6>
                </div>
                <div class="card-body">
    `;
    
    data.results.forEach((result, index) => {
        const icon = result.is_correct ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        const bgClass = result.is_correct ? 'bg-light-success' : 'bg-light-danger';
        
        html += `
            <div class="d-flex align-items-center mb-3 p-3 rounded ${bgClass}">
                <i class="${icon} fa-lg me-3"></i>
                <div class="flex-grow-1">
                    <strong>Question ${index + 1}:</strong> 
                    <span class="badge ${result.is_correct ? 'bg-success' : 'bg-danger'} ms-2">
                        ${result.is_correct ? 'Correct ‚úì' : 'Incorrect ‚úó'}
                    </span>
                    ${!result.is_correct ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-arrow-right me-1"></i>
                                Correct answer: <strong class="text-success">${result.correct_option}</strong>
                            </small>
                        </div>
                    ` : `
                        <div class="mt-1">
                            <small class="text-success">
                                <i class="fas fa-check me-1"></i>Well done!
                            </small>
                        </div>
                    `}
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <button class="btn btn-primary btn-lg w-100" onclick="retakeQuiz()">
                        <i class="fas fa-redo me-2"></i>Try Again & Improve
                    </button>
                </div>
                <div class="col-md-6">
                    <a href="${window.location.origin}" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Create New Study Plan
                    </a>
                </div>
            </div>
            
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Personalized Study Tips</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üìö For Better Results:</h6>
                            <ul class="list-unstyled">
                                ${scorePercentage < 70 ? `
                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Review the topics you missed carefully</li>
                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Create flashcards for key concepts</li>
                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Practice with similar questions</li>
                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Take breaks between study sessions</li>
                                ` : `
                                    <li><i class="fas fa-arrow-right text-success me-2"></i>Excellent! Keep practicing regularly</li>
                                    <li><i class="fas fa-arrow-right text-success me-2"></i>Try teaching concepts to others</li>
                                    <li><i class="fas fa-arrow-right text-success me-2"></i>Challenge yourself with advanced topics</li>
                                    <li><i class="fas fa-arrow-right text-success me-2"></i>Maintain consistent study habits</li>
                                `}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">üéØ Next Steps:</h6>
                            <div class="alert alert-light">
                                ${scorePercentage >= 80 ? 
                                    `<strong>Amazing work!</strong> You're ready to move on to more advanced topics. Consider exploring related subjects or diving deeper into complex concepts.` :
                                    scorePercentage >= 60 ?
                                    `<strong>Good progress!</strong> Focus on the areas you missed and try the quiz again. You're on the right track!` :
                                    `<strong>Keep going!</strong> Learning takes time and practice. Review the material, take notes, and don't hesitate to try again. Every attempt makes you stronger!`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Scroll to results with smooth animation
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Show motivational popup for high scores
    if (scorePercentage >= 90) {
        setTimeout(() => {
            showCelebrationModal(scorePercentage);
        }, 1000);
    }
}

function showCelebrationModal(score) {
    const modalHtml = `
        <div class="modal fade" id="celebrationModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-5">
                        <i class="fas fa-trophy fa-4x text-warning mb-3 celebration-animation"></i>
                        <h3 class="text-primary mb-3">Congratulations!</h3>
                        <p class="lead mb-4">You scored ${score}%! You're truly mastering this subject!</p>
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-smile me-2"></i>Thank You!
                            </button>
                            <button type="button" class="btn btn-success" onclick="shareSuccess(${score})" data-bs-dismiss="modal">
                                <i class="fas fa-share me-2"></i>Share Success
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('celebrationModal'));
    modal.show();
    
    // Remove modal after it's hidden
    document.getElementById('celebrationModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function shareSuccess(score) {
    const text = `I just scored ${score}% on my AI Study Pal quiz! üéâ #AIStudyPal #Learning`;
    if (navigator.share) {
        navigator.share({
            title: 'AI Study Pal Success',
            text: text,
            url: window.location.href
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(text).then(() => {
            alert('Success message copied to clipboard!');
        });
    }
}

function retakeQuiz() {
    // Reset the quiz form
    const form = document.getElementById('quizForm');
    const inputs = form.querySelectorAll('input[type="radio"]');
    inputs.forEach(input => input.checked = false);
    
    // Hide results
    document.getElementById('quizResults').style.display = 'none';
    
    // Scroll back to quiz
    form.scrollIntoView({ behavior: 'smooth' });
    
    // Show encouraging message
    const tempAlert = document.createElement('div');
    tempAlert.className = 'alert alert-info alert-dismissible fade show fade-in-up';
    tempAlert.innerHTML = `
        <i class="fas fa-rocket me-2"></i>
        <strong>Ready for round two?</strong> You've got this! Take your time and think through each question carefully.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    form.parentNode.insertBefore(tempAlert, form);
    
    // Auto-dismiss the alert after 6 seconds
    setTimeout(() => {
        if (tempAlert.parentNode) {
            tempAlert.classList.add('fade');
            setTimeout(() => tempAlert.remove(), 150);
        }
    }, 6000);
}
</script>
{% endblock %}